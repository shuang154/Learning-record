{% extends "base.html" %}

{% block content %}
<div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">今日学习记录 ({{ today.strftime('%Y-%m-%d') }})</h1>
        <div class="space-x-2">
            <button id="modify-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">修改选中</button>
            <button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">删除选中</button>
        </div>
    </div>
    
    {% if sessions %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                           <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">科目</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">开始时间</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">结束时间</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">学习时长 (分钟)</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    {% for session in sessions %}
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="session-checkbox h-4 w-4 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500" value="{{ session.id }}" data-duration="{{ (session.duration_seconds / 60) | round(1) if session.duration_seconds is not none else '' }}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{{ session.subject }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">{{ session.start_time.strftime('%H:%M:%S') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">{{ session.end_time.strftime('%H:%M:%S') if session.end_time else '进行中...' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">
                            {{ (session.duration_seconds / 60) | round(1) if session.duration_seconds else '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-gray-400">今天还没有学习记录，快去开始学习吧！</p>
    {% endif %}
</div>

<div id="modify-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm border border-gray-700">
        <h3 class="text-xl font-bold text-white mb-4">修改学习时长</h3>
        <div>
            <label for="new-duration-input" class="block text-sm font-medium text-gray-300">新的时长 (分钟)</label>
            <input type="number" id="new-duration-input" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="例如: 45.5">
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
            <button id="save-changes-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">保存更改</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const deleteBtn = document.getElementById('delete-btn');
    const modifyBtn = document.getElementById('modify-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const sessionCheckboxes = document.querySelectorAll('.session-checkbox');

    const modal = document.getElementById('modify-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const newDurationInput = document.getElementById('new-duration-input');

    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', (e) => {
        sessionCheckboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });

    // 删除逻辑
    deleteBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(sessionCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            alert('请至少选择一条记录进行删除。');
            return;
        }

        if (confirm(`确定要删除选中的 ${selectedIds.length} 条记录吗？`)) {
            try {
                const response = await fetch("{{ url_for('routes.delete_sessions') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_ids: selectedIds })
                });

                if (response.ok) {
                    alert('删除成功！');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('删除失败: ' + (error.error || '未知错误'));
                }
            } catch (err) {
                alert('请求失败，请检查网络连接。');
            }
        }
    });

    // 修改逻辑
    modifyBtn.addEventListener('click', () => {
        const selectedCheckboxes = Array.from(sessionCheckboxes).filter(cb => cb.checked);
        
        if (selectedCheckboxes.length !== 1) {
            alert('请选择且仅选择一条记录进行修改。');
            return;
        }
        
        const checkbox = selectedCheckboxes[0];
        const sessionId = checkbox.value;
        const currentDuration = checkbox.dataset.duration;

        newDurationInput.value = currentDuration;
        modal.dataset.sessionId = sessionId; // 将ID存到modal的data属性中
        modal.classList.remove('hidden');
    });

    // 关闭弹窗
    cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    // 保存修改
    saveChangesBtn.addEventListener('click', async () => {
        const sessionId = modal.dataset.sessionId;
        const newDuration = newDurationInput.value;

        if (!sessionId || newDuration.trim() === '') {
            alert('时长不能为空。');
            return;
        }

        try {
            const response = await fetch(`/modify_session/${sessionId}`, { // 直接构造URL
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration_minutes: newDuration })
            });

            if (response.ok) {
                alert('修改成功！');
                location.reload();
            } else {
                const error = await response.json();
                alert('修改失败: ' + (error.error || '未知错误'));
            }
        } catch (err) {
            alert('请求失败，请检查网络连接。');
        }
    });
});
</script>
{% endblock %}