{% extends "base.html" %}

{% block content %}
<div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">今日学习记录 ({{ today.strftime('%Y-%m-%d') }})</h1>
        <div class="space-x-2">
            <button id="modify-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">修改选中</button>
            <button id="delete-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition">删除选中</button>
        </div>
    </div>
    
    {% if sessions %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                           <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">科目</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">开始时间</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">结束时间</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">学习时长</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    {% for session in sessions %}
                    <tr class="hover:bg-gray-700/50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="session-checkbox h-4 w-4 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500" value="{{ session.id }}" data-duration-seconds="{{ session.accumulated_seconds if session.accumulated_seconds is not none else '0' }}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{{ session.subject.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">{{ session.creation_time.strftime('%H:%M:%S') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">{{ session.end_time.strftime('%H:%M:%S') if session.end_time else '进行中...' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 tabular-nums-font">
                            {{ session.accumulated_seconds | duration }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-gray-400">今天还没有学习记录，快去开始学习吧！</p>
    {% endif %}
</div>

<div id="modify-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm border border-gray-700">
        <h3 class="text-xl font-bold text-white mb-4">修改学习时长</h3>
        <div class="flex items-center space-x-2">
            <div class="flex-1">
                <label for="new-duration-hours" class="block text-sm font-medium text-gray-300">时</label>
                <input type="number" id="new-duration-hours" min="0" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="h">
            </div>
            <div class="flex-1">
                <label for="new-duration-minutes" class="block text-sm font-medium text-gray-300">分</label>
                <input type="number" id="new-duration-minutes" min="0" max="59" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="m">
            </div>
            <div class="flex-1">
                <label for="new-duration-seconds" class="block text-sm font-medium text-gray-300">秒</label>
                <input type="number" id="new-duration-seconds" min="0" max="59" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="s">
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
            <button id="save-changes-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">保存更改</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 按钮和Checkbox的获取 (无变化) ---
    const deleteBtn = document.getElementById('delete-btn');
    const modifyBtn = document.getElementById('modify-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const sessionCheckboxes = document.querySelectorAll('.session-checkbox');
    
    // --- 弹窗元素获取 (已更新) ---
    const modal = document.getElementById('modify-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const hoursInput = document.getElementById('new-duration-hours');
    const minutesInput = document.getElementById('new-duration-minutes');
    const secondsInput = document.getElementById('new-duration-seconds');

    // --- 全选/删除逻辑 (无变化) ---
    selectAllCheckbox.addEventListener('change', (e) => {
        sessionCheckboxes.forEach(checkbox => { checkbox.checked = e.target.checked; });
    });
    deleteBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(sessionCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        if (selectedIds.length === 0) { alert('请至少选择一条记录进行删除。'); return; }
        if (confirm(`确定要删除选中的 ${selectedIds.length} 条记录吗？`)) {
            try {
                const response = await fetch("{{ url_for('routes.delete_sessions') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_ids: selectedIds })
                });
                if (response.ok) {
                    alert('删除成功！');
                    location.reload();
                } else {
                    alert('删除失败: ' + ((await response.json()).error || '未知错误'));
                }
            } catch (err) {
                alert('请求失败，请检查网络连接。');
            }
        }
    });

    // --- 修改按钮点击逻辑 (已更新) ---
    modifyBtn.addEventListener('click', () => {
        const selectedCheckboxes = Array.from(sessionCheckboxes).filter(cb => cb.checked);
        if (selectedCheckboxes.length !== 1) {
            alert('请选择且仅选择一条记录进行修改。');
            return;
        }
        
        const checkbox = selectedCheckboxes[0];
        const sessionId = checkbox.value;
        const totalSeconds = parseInt(checkbox.dataset.durationSeconds, 10);

        // 将总秒数分解为 h, m, s
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        // 填充到输入框
        hoursInput.value = hours;
        minutesInput.value = minutes;
        secondsInput.value = seconds;
        
        modal.dataset.sessionId = sessionId;
        modal.classList.remove('hidden');
    });

    // --- 关闭弹窗 (无变化) ---
    cancelBtn.addEventListener('click', () => { modal.classList.add('hidden'); });

    // --- 保存修改逻辑 (已更新) ---
    saveChangesBtn.addEventListener('click', async () => {
        const sessionId = modal.dataset.sessionId;
        
        // 从输入框读取 h, m, s 并计算总秒数
        const h = parseInt(hoursInput.value, 10) || 0;
        const m = parseInt(minutesInput.value, 10) || 0;
        const s = parseInt(secondsInput.value, 10) || 0;
        const totalSeconds = (h * 3600) + (m * 60) + s;

        if (!sessionId) return;
        
        try {
            const response = await fetch(`/modify_session/${sessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // 发送总秒数到后端
                body: JSON.stringify({ duration_seconds: totalSeconds })
            });
            if (response.ok) {
                alert('修改成功！');
                location.reload();
            } else {
                alert('修改失败: ' + ((await response.json()).error || '未知错误'));
            }
        } catch (err) {
            alert('请求失败，请检查网络连接。');
        }
    });
});
</script>
{% endblock %}